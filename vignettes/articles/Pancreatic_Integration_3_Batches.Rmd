---
title: "Batch Effect Correction on Pancreatic Cells (Multi-Batch)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Batch Effect Correction on Pancreatic Cells}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.align = "center",
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(Canek)
library(Seurat)
library(SeuratData)
```

In this example we integrate three batches (celseq, celseq2 and smartseq2). We show the difference on the integration order by changing the parameter "Hierarchical". This parameter is set as TRUE by default, meaning that we will integrate the first batch with the batch with has more MNN pairs under the first two principal components representation. With this, we aim to improve the integration between dissimilar batches, by first joining those batches which share a higher number of similar cells. 

```{r}
InstallData("panc8")
```

Select datasets and fix correction order. On this case we choose this especific order on the batches to better show the difference on the integration order.

```{r}
x <- panc8[, panc8$tech %in% c("celseq2", "smartseq2", "celseq")]
x$tech <- factor(x$tech, c("celseq", "smartseq2", "celseq2"))
```

# Data preprocessing

```{r}
x <- NormalizeData(x)
x <- FindVariableFeatures(x, selection.method = "mean.var.plot")
VariableFeaturePlot(x)
```

```{r}
table(x$tech)
```

```{r}
x <- ScaleData(x)
```

```{r}
x <- RunPCA(x)
x <- RunUMAP(x, reduction = "pca", dims = 1:30)
```

# UMAP plot before correction

By analyzing the UMAP representation, we can see a closer similarity between celseq and celseq2 batches, which have a shorter distance as compared with smartseq2.
```{r}
DimPlot(x, group.by = "tech")
DimPlot(x, group.by = "celltype")
```

# Run Canek with no Hierarchical integration.

We pass the column containing the batch information. On this integration we set "Hierarchical" as FALSE, meaning that the integration is performed on the same order defined on the batches list. We set the "Verbose" as TRUE to display the information related. 
We can see that the order of integrations are defined by the batches list order, with the first integration between celseq and smartseq2 batches, and the second between the already corrected celseq/smartseq2 and celseq2. 

```{r}
x <- RunCanek(x, "tech", Verbose = TRUE, Hierarchical = FALSE)
```

```{r}
x <- ScaleData(x)
```

```{r}
x <- FindVariableFeatures(x, selection.method = "mean.var.plot")
VariableFeaturePlot(x)
```

```{r}
x <- RunPCA(x)
x <- RunUMAP(x, reduction = "pca", dims = 1:30)
```

# UMAP plot after correction

```{r}
DimPlot(x, group.by = "tech")
DimPlot(x, group.by = "celltype")
```

# Run Canek with Hierarchical integration.

Now, we integrate under a hierarchical scheme, where more similar batches are integrated first. Similar batches are defined as being those batches which share a higher number of MNNs pairs. 
We can see that the first integration is done between celseq and celseq2 batches, and the second between the already integrated celseq/celseq2 and smartseq2 batches. 

```{r}
x <- RunCanek(x, "tech", Verbose = TRUE, Hierarchical = TRUE)
```

```{r}
x <- ScaleData(x)
```

```{r}
x <- FindVariableFeatures(x, selection.method = "mean.var.plot")
VariableFeaturePlot(x)
```

```{r}
x <- RunPCA(x)
x <- RunUMAP(x, reduction = "pca", dims = 1:30)
```

# UMAP plot after correction

```{r}
DimPlot(x, group.by = "tech")
DimPlot(x, group.by = "celltype")
```

By comparing the two solutions' UMAP representation, even though they are quite similar, we can see that the last one shares more similarity with the uncorrected batches structure.



