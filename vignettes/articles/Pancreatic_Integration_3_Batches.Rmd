---
title: "Batch Effect Correction on Pancreatic Cells"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Batch Effect Correction on Pancreatic Cells}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.align = "center",
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(Canek)
library(Seurat)
library(SeuratData)
```

In this example we integrate only two batches (celseq and celseq2). See the vignette "Batch Effect Correction on Pancreatic Cells (multiple batches)" for an example of multiple batches integration. 

```{r}
InstallData("panc8")
```

Select datasets and fix correction order (for this example).

```{r}
x <- panc8[, panc8$tech %in% c("celseq2", "smartseq2", "celseq")]
x$tech <- factor(x$tech, c("celseq", "smartseq2", "celseq2"))
```

# Data preprocessing

```{r}
x <- NormalizeData(x)
x <- FindVariableFeatures(x, selection.method = "mean.var.plot")
VariableFeaturePlot(x)
```

```{r}
table(x$tech)
```

```{r}
x <- ScaleData(x)
```

```{r}
x <- RunPCA(x)
x <- RunUMAP(x, reduction = "pca", dims = 1:30)
```

# UMAP plot before correction

```{r}
DimPlot(x, group.by = "tech")
DimPlot(x, group.by = "celltype")
```

# Run Canek

We pass the column containing the batch information.

```{r}
x <- RunCanek(x, "tech", Verbose = TRUE, Hierarchical = TRUE)
```


```{r}
x <- ScaleData(x)
```

```{r}
x <- FindVariableFeatures(x, selection.method = "mean.var.plot")
VariableFeaturePlot(x)
```

```{r}
x <- RunPCA(x)
x <- RunUMAP(x, reduction = "pca", dims = 1:30)
```

# UMAP plot after correction

```{r}
DimPlot(x, group.by = "tech")
DimPlot(x, group.by = "celltype")
```






